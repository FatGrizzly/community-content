---
SPDX-License-Identifier: MIT
path: "/tutorials/cloudflare-website-protect"
slug: "protecting-a-website-with-cloudflare"
date: "2024-03-17"
title: "How to protect a website with Cloudflare without exposing ports to the internet"
short_description: "This tutorial explains how to protect a website with Cloudflare's L7 protection without exposing ports"
tags: ["Cloudflare", "NGINX", "Website","DDOS-Protection"]
author: "Soundarahari Parthiban"
author_link: "https://github.com/FatGrizzly"
author_img: "https://avatars3.githubusercontent.com/u/66728880"
author_description: "Linux sys-admin fiddling with servers"
language: "en"
available_languages: ["en"]
header_img: "header-3"
cta: "cloud"
---

## Introduction

Hello, and welcome to this tutorial on how to protect a website with Cloudflare.
In this tutorial, we would be hosting a website on a Hetzner Cloud server and protect it with Cloudflare's awesome L7 protection while staying secure and locking down the server's ports so that the attacker cannnot bypass Cloudflare and attack the server directly.

Before we get started, a small gist on Cloudflare and its features,

Cloudflare is one of the worldâ€™s largest networks. Today, businesses, non-profits, bloggers, and anyone with an Internet presence boast faster, more secure websites and apps, they are protected from DDoS attacks, and their origin servers are shielded from the attackers. Cloudflare also provides a suite of security services that protect the website from attacks, such as SQL injection, XSS, and DDoS attacks.

Cloudflare powers Internet requests for millions of websites and serves 55 million HTTP requests per second on average.

Cloudflare has made huge improvements in the security and performance of the internet. It is a great tool for website owners to protect their websites from attacks and improve the performance of their websites, best part is that it is free to use.

As your traffic goes higher, you can always upgrade to a paid plan for more features and better performance.

**Prerequisites**

This guide assumes that you have already added your domain to Cloudflare and have pointed to the Cloudflare nameservers. If you haven't done that yet, you can follow the guide [here](https://developers.cloudflare.com/fundamentals/setup/manage-domains/add-site/).

If you do not have a domain yet, you can get one from any domain registrar, I would recommend [Hetzner](https://www.hetzner.com/domainregistration/).

Before we get started, you will need the following:
* A domain name
* A Cloudflare account with the domain added
* A server running Debian 12(other distro's should work too, but this tutorial is based on Debian 12)
* A website to protect


## Step 1 - Updating the server and installing NGINX

First and foremost, we need to update the server, then we should add the NGINX repository and install NGINX.

```bash
apt update && apt upgrade -y
apt install curl gnupg2 ca-certificates lsb-release debian-archive-keyring -y
# Add the signing key for the nginx packages
curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor | tee /usr/share/keyrings/nginx-archive-keyring.gpg > /dev/null
# Add the NGINX repository
echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/debian `lsb_release -cs` nginx" | tee /etc/apt/sources.list.d/nginx.list
# Pin down the NGINX repository to avoid conflicts with the default Debian repository
echo -e "Package: *\nPin: origin nginx.org\nPin: release o=nginx\nPin-Priority: 900\n" | tee /etc/apt/preferences.d/99nginx
apt update
# Install NGINX
apt install nginx -y
```


## Step 2 - Website setup and configuration

Configuring NGINX to serve the website is out of scope for this tutorial, but we will be using default configurations for this tutorial and securing the server with Cloudflare.

You can adapt the following configuration to your website's needs.

You would also need to generate an origin certificate from Cloudflare and place it in the `/etc/nginx/ssl` directory, namely `cf.crt` and `cf.key`.

You can generate the origin certificate from the Cloudflare dashboard by navigating to SSL/TLS -> Origin Server -> Create Certificate.

```nginx
server {
    listen       443 ssl;
    server_name  <example.com>;
    access_log  /var/log/nginx/host.access.log  main;
    ssl_certificate /etc/nginx/ssl/cf.crt;
    ssl_certificate_key /etc/nginx/ssl/cf.key;
    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;
    }
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }
}
```

### Step 2.1 - Reload NGINX and Point the domain to the server

In this step, we will reload NGINX to apply the changes and point the domain to the server.

```bash
systemctl reload nginx
```

After reloading NGINX, you can point the domain to the server by adding an A record in the Cloudflare dashboard, make sure the proxy status is set to "Proxied" to enable Cloudflare's L7 protection, else the server will be exposed to the internet.

## Step 3 - 60% of the way there

We are now 60% of the way there, the website is now protected by Cloudflare's L7 protection, but the server is still exposed to the internet, and an attacker can bypass Cloudflare and attack the server directly.

In the next steps, we will be locking down the server's ports and only allowing Cloudflare's IP ranges to access the server.

We can use iptables to achieve this, but we will be going one step further and use Hetzner's Cloud Firewall to lock down the server's ports.

## Step 4 - Setting up Hetzner Cloud Firewall

In this step, we will be setting up Hetzner's Cloud Firewall to lock down the server's ports and only allow Cloudflare's IP ranges to access the server.

This can be done via the Hetzner Cloud dashboard, by navigating to the server's page and clicking on the "Firewall" tab.

But we will be using the Hetzner Cloud API to automate this process, because Cloudflare's IP ranges are dynamic and can change over time.

First, we need to create an API token from the Hetzner Cloud dashboard, by navigating to the "API Tokens" page and clicking on "Generate API Token".

Then we need to create a firewall in the Hetzner Cloud dashboard and note down the firewall ID, which can be found in the URL when you are on the firewall's page.

Make sure that the firewall is applied to the server, else its of no use.

Substitute API token and firewall ID in the following script and run it to whitelist Cloudflare's IP ranges in the Hetzner Cloud Firewall.

```python
import requests
import json

HETZNER_API_TOKEN = "YOUR_HETZNER_API_TOKEN"
HETZNER_FIREWALL_ID = "YOUR_HETZNER_FIREWALL_ID"
def get_cloudflare_ips():
    response = requests.get('https://www.cloudflare.com/ips-v4')
    if response.status_code == 200:
        return response.text.strip().split('\n')
    else:
        print("Failed to retrieve Cloudflare IP ranges")
        return []

def whitelist_ips_in_hetzner(ip_ranges):
    headers = {
        'Authorization': f'Bearer {HETZNER_API_TOKEN}',
        'Content-Type': 'application/json',
    }
    payload = {
        "rules": [
            {
                "direction": "in",
                "source_ips": ip_ranges,
                "port": "443",
                "protocol": "tcp",
                "description": "accept port 443"
            }
        ]
    }
    
    response = requests.put(f'https://api.hetzner.cloud/v1/firewalls/{HETZNER_FIREWALL_ID}', headers=headers, data=json.dumps(payload))
    if response.status_code == 200:
        print("IPs whitelisted successfully in Hetzner Firewall")
    else:
        print("Failed to whitelist IPs in Hetzner Firewall", response.json())

if __name__ == "__main__":
    cloudflare_ips = get_cloudflare_ips()
    whitelist_ips_in_hetzner(cloudflare_ips)
```

## Step 5 - Run the script and automate it

To run the script, you need to have Python installed on the server, if not, you can install it by running `apt install python3 -y`.

Now once you have Python installed, you can run the script by saving it to a file, say `firewall.py` and running `python3 firewall.py`.

You should be expecting an output like "IPs whitelisted successfully in Hetzner Firewall", if not you can check the error message and troubleshoot.

Once you have the script running successfully, you can automate it by adding it to a cron job, so that the script runs every 24 hours and updates the Hetzner Cloud Firewall with Cloudflare's IP ranges.

A cron job can be added by running `crontab -e` and adding the following line to the file.

```bash
* 0 * * * /usr/bin/python3 /path/to/firewall.py
```

## Step 6 - Hardening the protection on Cloudflare side.

Login to your Cloudflare dashboard and navigate to the "SSL/TLS" tab and enable "Always Use HTTPS" and "Automatic HTTPS Rewrites", also set the SSL/TLS encryption mode to "Full (strict)".

This will ensure that the website is always served over HTTPS and the connection between Cloudflare and the server is encrypted and secure.

Now, navigate to the "Security" tab and enable "Browser Integrity Check","Hotlink Protection", "Bot Fight Mode".

This will ensure that the website is protected from bots, hotlinking and other attacks.

Do note that this is not a one-size-fits-all solution, and you should always keep an eye on the Cloudflare dashboard and tweak the settings according to your website's needs.

You can also enable "Rate Limiting" to further protect the website from attacks, and luckily, Cloudflare provides a free tier for this feature(includes one rule).

Cloudflare's caching feature can also be used to cache the website's static content and reduce the server's load.

and once again, you should monitor traffic and tweak the settings according to your website's needs.

There's also this script https://github.com/guided-hacking/cfautouam that can be used to automatically turn on Cloudflare Under Attack Mode when the server is using too much CPU or RAM, this can be useful to protect the server from attacks, but this is out of scope for this tutorial.

## Conclusion

In this tutorial, we have learned how to protect a website with Cloudflare's L7 protection without exposing ports to the internet, securing the server and the website from attacks.

We have also automated the process of updating the Hetzner Cloud Firewall with Cloudflare's IP ranges, and hardened the protection on Cloudflare's side.

I hope this tutorial was helpful and you were able to protect your website with Cloudflare.

Monitor the website's traffic and tweak the settings according to your website's needs, and always keep an eye on the Cloudflare dashboard for any alerts and warnings.

##### License: MIT

<!--

Contributor's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Soundarahari Parthiban <administrator@soundar.net>

-->
